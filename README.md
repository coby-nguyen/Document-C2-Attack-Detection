# Document-C2-Attack-Detection

[I. Project](#i-project)

## I. Project:
The goal of this project is to simulate a real cyber attack and endpoint detection and response. In this project, I will use Wazuh as an XDR and SIEM solution, including a Wazuh Manager/Server and a Wazuh Agent. The attack machine will utilize 'Havoc' as a C2 framework to target a Windows endpoint machine that is running the Wazuh Agent.

<img width="1232" height="772" alt="image" src="https://github.com/coby-nguyen/Document-C2-Attack-Detection/blob/main/images/havoc-project.png" />

## II. Setup
This lab includes two Kali Linux VMs and one Windows 11 VM. The first Kali Linux machine will be installed with the Havoc C2 Framework as the primary attack tool, while the second machine will run the Wazuh Manager, receiving logs and events from the agent, and performing active responses when alerts are triggered. The victim machine will run on Windows 11, including the Wazuh Agent integrated with Sysmon. Moreover, YARA will be integrated with Wazuh for malware scanning and active response. 

Three machines will have the following IP addresses:
- Attacker Machine (Kali Linux): 192.168.1.86
- Wazuh Server (Kali Linux): 192.168.1.82
- Victim Machine (Windows 11): 192.168.1.107

### Attack Machine
- The [Havoc C2 Framework](https://havocframework.com/) has been installed on one of my Kali Linux machines. The first step is starting the Havoc Teamserver, which is the core server that creates listeners, interacts with agents, and handles the operator's commands.

<img width="1084" height="653" alt="image" src="https://github.com/user-attachments/assets/82ef2e86-a73b-4010-8e95-40f62134f516" />

<p></p>

- After that, I will start the Havoc Client with the default credentials. The Havoc Client connects to the Teamserver and provides a User Interface (UI) and management of beacons, listeners, payloads, and so much more.

<img width="1664" height="638" alt="image" src="https://github.com/user-attachments/assets/d0c9abc9-d836-40bd-854b-c2a8c083ca92" />

<p></p>

- To execute payloads and interact with agents, we need a Havoc listener, which can be created in the Havoc Client UI. After being successfully authenticated to the Client UI, I will create a listener.

<img width="599" height="804" alt="image" src="https://github.com/user-attachments/assets/cd178bbe-10fd-4176-87f5-a9c7e2eb08f9" />

<img width="737" height="255" alt="image" src="https://github.com/user-attachments/assets/a9f73a49-d74b-4f3d-b2f1-f6cc96e0b7c5" />

<p></p>

- Lastly, I am going to compile a payload, which will be used as malware for compromising the target later. The payload will then be saved as "notepad.exe" in *./havoc/Havoc/payloads*.

<img width="576" height="918" alt="image" src="https://github.com/user-attachments/assets/9cea3108-a38c-4420-b39b-2d713fb17a93" />

<img width="875" height="721" alt="image" src="https://github.com/user-attachments/assets/43ee9836-3f85-4fce-8415-b5eaef0072c5" />

### Victim Machine
- To detect events generated by the Havoc C2 framework, I installed Sysmon from the [Microsoft Sysinternals page](https://docs.microsoft.com/en-us/sysinternals/downloads/sysmon) and configured it using a [Sysmon configuration file](https://wazuh.com/resources/blog/detecting-process-injection-with-wazuh/sysmonconfig.xml). Then, I edited the Wazuh agent *C:\Program Files (x86)\ossec-agent\ossec.conf* file to specify the location to collect Sysmon logs.

<img width="989" height="318" alt="image" src="https://github.com/user-attachments/assets/f6fa7e6b-713f-485c-94f6-592ecdced071" />

<img width="947" height="646" alt="image" src="https://github.com/user-attachments/assets/56374ec4-eecd-4b6b-8cd9-283be36ebd2a" />

<p></p>

- In this lab, I will integrate YARA, a tool used to create rules for detecting specific patterns in files or processes, with Wazuh, and use it to detect the presence of the Havoc C2 implant on the endpoint. Firstly, I will download the YARA executable on the endpoint using PowerShell as an administrator.
  
<img width="1333" height="211" alt="image" src="https://github.com/user-attachments/assets/acea9f62-d45b-4aa4-b7e2-285cf01e207e" />

<p ></p>

- Next, I will create a *yara.bat* script in the *C:\Program Files (x86)\ossec-agent\active-response\bin* path, which will do the followings:
  * Detects Windows architecture
  * Receives JSON from Wazuh
  * Extracts the file path of a modified file
  * Runs YARA rules on that file
  * Logs the YARA scan results

<img width="1527" height="775" alt="image" src="https://github.com/user-attachments/assets/841e649c-aa15-4a47-a6ba-c058765249a9" />

<p></p>

- After that, I will create a folder named *yara* in the *C:\Program Files (x86)\ossec-agent\active-response\bin* path and copy the downloaded YARA executable into it.

<img width="609" height="202" alt="image" src="https://github.com/user-attachments/assets/2a8e110e-1c49-4740-a9cf-c1764d75fff8" />

<p></p>

- Moreover, we need to download the *yara_rules.yar*, a pre-written set of different YARA rules, which will be used by YARA to scan the incoming malware. Firstly, we need to  install the *valhallaAPI* module with admin privileges. Secondly, I will download YARA rules with a Python script. Lastly, the installed YARA rules will be moved to *C:\Program Files (x86)\ossec-agent\active-response\bin\yara\rules*.

<img width="1349" height="515" alt="image" src="https://github.com/user-attachments/assets/f5338ab9-f1db-418e-a24a-c2f40929e1ad" />

<p></p>

- After that, I will append the Havoc detection rules to the *yara_rules.yar* file.

<img width="667" height="457" alt="image" src="https://github.com/user-attachments/assets/62db5246-7e86-4064-a3a2-912aa9e50688" />

<p></p>

- Lastly, I will add the endpoint *Downloads* directory to the *<syscheck>* block in the Wazuh agent configuration file *C:\Program Files (x86)\ossec-agent\ossec.conf*. The *<syscheck>* tag configures the OSSEC File Integrity Monitoring (FIM), monitoring file system changes to detect the creation, modification, and deletion of files.

<img width="1376" height="526" alt="image" src="https://github.com/user-attachments/assets/4417d5cb-2330-432b-a7af-ada0e008bcac" />

<p></p>

- Additionally, we will check the status of the Wazuh Agent.

<img width="459" height="185" alt="Screenshot 2025-12-05 162253" src="https://github.com/user-attachments/assets/21592ae6-816f-43f3-b222-638ca26d6988" />

<p></p>

### Wazuh Server

- On the Kali Linux machine hosting the Wazuh Server, I will perform some configurations to generate an alert for changes in the monitored directory of the Windows 11 endpoint. Firstly, I will create a *yara_decoder* in the */var/ossec/etc/decoders/local_decoder.xml*, which will parse the YARA result lines into fields.

<img width="1194" height="638" alt="image" src="https://github.com/user-attachments/assets/58a7f8a4-f94f-415f-a7ba-4d460353af78" />

<p></p>

- In the Wazuh server */var/ossec/etc/rules/local_rules.xml* configuration file, I will create some rules that do the following:
  * Rule ID __100770__ triggers when a file is modified in *C:\Users\kaine\Downloads* directory.
  * Rule ID __100771__ is triggered when a file is added to *C:\Users\kaine\Downloads* directory.
  * Rule ID __100880__ groups YARA rules together.
  * Rule ID __100881__ is triggered when a file has been identified as malware by a YARA scan.

<img width="1127" height="752" alt="image" src="https://github.com/user-attachments/assets/4f3a0702-9607-461b-adea-e9277852d992" />

<p></p>

- Lastly, I will configure the Wazuh active response in the Wazuh server */var/ossec/etc/ossec.conf* file. This configuration is set to respond when the YARA rules are triggered, to execute the yara.bat active response script.

<img width="412" height="228" alt="image" src="https://github.com/user-attachments/assets/47a8a61f-d8e3-406c-80ab-fea3624cc20b" />

<p></p>

- After the Wazuh server configuration, I will start the Wazuh server and log in with my credentials via https://192.168.1.82/. 

<img width="427" height="206" alt="image" src="https://github.com/user-attachments/assets/b6ea17f3-0d9f-4a9f-8cd6-c0f590eaf82f" />

<img width="1919" height="686" alt="Screenshot 2025-12-05 161003" src="https://github.com/user-attachments/assets/e8c9ef50-2576-4ab7-80ea-de091f5daa1b" />

<p></p>

## III. Simulation

### Attack

- After setting up the three-machine environment, the scenario begins on the attacker (red-team simulation) machine â€” Kali Linux (192.168.1.86). A simple Python HTTP server is started to simulate a legitimate website that the victim can access via *"192.168.1.86"*. The server also hosts the Havoc-generated payload, __notepad.exe__. When the victim visits the site, they must manually click the file to download it onto their Windows 11 machine, mimicking a common social-engineering technique used in real-world attacks.

<img width="460" height="89" alt="image" src="https://github.com/user-attachments/assets/7575c0bd-8666-48a6-8161-d56c41bb5449" />

<i>Attacker's Machine</i>

<p></p>

<img width="864" height="475" alt="image" src="https://github.com/user-attachments/assets/42557ad8-56ac-48c8-89e1-1f6b776791f9" />

<i>Victim's Machine</i>

<p></p>
 
- By clicking the __notepad.exe__, the victim will install it on their machine.

<img width="897" height="316" alt="image" src="https://github.com/user-attachments/assets/1288bd67-8683-4740-8a8f-b734e8137d46" />

<p></p>

- When the victim executes the downloaded payload, the Havoc demon agent will establish a reverse connection and call back to the Havoc Teamserver, creating a session. In the Client UI, we can see that a session has been initialized.

<img width="1918" height="490" alt="image" src="https://github.com/user-attachments/assets/1b0bbcda-42aa-4e0b-baf0-92f5958c520f" />

<p></p>

- From this moment, the attacker has compromised the victim's machine and gained control of it, creating a backdoor to the system with a Trojan. Therefore, the attacker can perform any action on the victim's machine via the Havoc Client UI. For example, I can take screenshots from the victim's machine, which will appear in the *Loot* or perform PowerShell commands, like "ls" or "pwd."

<img width="1920" height="935" alt="image" src="https://github.com/user-attachments/assets/f641ca91-0822-4fa0-ba70-6b876dbaaf53" />

<img width="1920" height="952" alt="image" src="https://github.com/user-attachments/assets/0acdf6b7-fcb4-4c7b-88a9-3d28c630d05b" />

<p></p>

### Defense
